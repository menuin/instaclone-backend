## ðŸŽ¨ DEVLOG 7/3

### #3.4 Prisma Setup

- **SQL ì½”ë“œë¥¼ ì“¸ í•„ìš” ì—†ì´ ìžë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì†Œí†µ(?)**

- íƒ€ìž…ìŠ¤í¬ë¦½íŠ¸ì™€ Prismaì˜ ì¡°í•©ì€ ìµœê³ @!

- ëª…ë ¹ì–´ )
  - npm install @prisma/cli -D
  - npx prisma init

- **prismaì— ì˜í•´ .env  íŒŒì¼ì´ ìƒì„±ë¨ (ë‚´ ë°ì´í„°ê°€ ì–´ë””ìžˆëŠ”ì§€ë¥¼ ì•Œì•„ì•¼ í•¨) **

  - PrismaëŠ” ORM (Object Relational Mapper) : ë°ì´í„°ë² ì´ìŠ¤ì™€ ëŒ€í™”í•´ì¤€ë‹¤ëŠ” ëœ»

- prisma/schema.prisma ëŠ” .envíŒŒì¼ì„ ì½ê³  í•´ë‹¹íŒŒì¼ì˜ **DATABASE_URL** ì„ ê°€ì ¸ì˜´

  .envíŒŒì¼ì€ gitignoreì— í¬í•¨ë˜ì–´ ìžˆìŒ (í™˜ê²½ë³€ìˆ˜ëŠ” ìš°ë¦¬ì˜ ì»´í“¨í„°ë¥¼ ìœ„í•œ ê²ƒì´ë‹¤!, ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ URLì´ ìœ ì¶œë˜ë©´ ì•ˆë˜ê¸° ë•Œë¬¸)

```prisma
// schema.prisma

datasource db {  
// it tells prisma 1.url of database 2. provider of database(what kind of db)
  provider = "postgresql"  
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

```

- ê¸°ë³¸ì ìœ¼ë¡œ PrismaëŠ” postgresqlë¥¼ ì‚¬ìš© => ìœˆë„ìš°ëŠ” postgresql ë‹¤ìš´ë¡œë“œ í›„ pgadmin4ë¥¼ ì„¤ì¹˜(ìœˆë„ìš°ì™€ postgreSQLì„ ìœ„í•œ GUI) 

- pgadmin4 ì‹¤í–‰í›„ ìƒˆ ë°ì´í„°ë² ì´ìŠ¤ (name : instaclone, owner: postgres) ë§Œë“  í›„ .env íŒŒì¼ì˜ DATABASE_URLì„ ì•„ëž˜ì™€ ê°™ì´ ìˆ˜ì • 

```
DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"
// this to

DATABASE_URL="postgresql://postgres:randompassword@localhost:5432/instaclone?schema=public"
// this
// johndoe -> postgres (owner ì´ë¦„)
// mydb -> instaclone (database ì´ë¦„)
```

- Prisma ì„¸íŒ… ë!



### #3.5 Prisma Migrate

- Let's skip the client now (in schema.prisma), and move on to migrate
- Prisma migrate allows you to **write and describe your data models** and ê·¸ ì„¤ëª…ë“¤ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì ìš© (ë°ì´í„°ë² ì´ìŠ¤ì˜ í˜•íƒœë¥¼ ë³€í˜•)

1. **Write your model**

```
// schema.prisma

model Movie {
  id  Int @default(autoincrement()) @id
  // default ê°’ì„ ì„¤ì •í•  ìˆ˜ ìžˆê³ , ìžë™ìœ¼ë¡œ ìˆ«ìžë¥¼ ì¦ê°€ì‹œí‚¬ ê²ƒì´ë‹¤
  // @id ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ê²Œ ì´ê²Œ ëª¨ë¸ì˜ idìž„ì„ ì „ë‹¬í•˜ê¸° ìœ„í•¨
  title String
  year Int
  genre String?  // ? means it is not "required"
  createdAt DateTime @default(now())
  // ëª¨ë¸ì´ ìƒì„±ëì„ ë•Œ ë°ì´í„°ë² ì´ìŠ¤ì— í˜„ìž¬ ì‹œê°„ì„ ì¶”ê°€
  // Type DateTimeì€ ì´ë¯¸ Prismaì—ì„œ ì œê³µë˜ê³  ìžˆìŒ
  updatedAt DateTime @updatedAt  // Movieë¥¼ ì €ìž¥í•  ë•Œë§ˆë‹¤ dateë¥¼ ì €ìž¥í•˜ê² ë‹¤
}
```

âœ‹ **schemaë¥¼ ìˆ˜ì •í–ˆìœ¼ë©´ typeDefë„ ìˆ˜ì •í•´ì£¼ê¸°!!!**

```js
// server.js
const typeDefs = gql`
type Movie {
    id : Int!
    title : String!
    year : Int!
    genre : String
    createdAt : String!
    updatedAt : String!
}` // graphql
```

- prismaëŠ” ëª¨ë“  ê²ƒë“¤ì´ ê¸°ë³¸ì ìœ¼ë¡œ requiredë‹¤ (graphqì€ ì§ì ‘ ì§€ì •í•´ì¤˜ì•¼í•¨)

1. **Prisma migrate**

   ëª…ë ¹ì–´ : `npx prisma migrate dev --name init --preview-feature`

   - --name initì€ ë¶ˆí•„ìš” : ë‚˜ì¤‘ì— migrationì—ì„œ ì¤„ ìˆ˜ ìžˆìŒ

   - --preview-feature : prisma migrateì€ ì•ˆì •ì ì¸ í”„ë¡œì íŠ¸ëŠ” ì•„ë‹ˆë¼ì„œ ì•„ì§ í• ì¼ì´ ë§Žì´ ë‚¨ì•˜ë‹¤ëŠ” ëœ» (ì‹¤í—˜ë‹¨ê³„ëŠ” ì•„ë‹ˆê³  preview ë‹¨ê³„ë¼ëŠ” ëœ», ì´ë¶€ë¶„ì€ ë‚˜ì¤‘ì— ì‚¬ë¼ì§ˆ ê²ƒìž„)

     - ë”°ë¼ì„œ ì§€ê¸ˆì€ `npx prisma migrate dev --preview-feature`ë¡œ ì‹¤í–‰í•œë‹¤
     - ì•„ ì§€ê¸ˆì€ ì‚¬ë¼ì¡Œë‹¤ê³  í•œë‹¤ `npx prisma migrate dev`ë¼ê³  ì¨ë„ ë¨!!!
     - ì´ ëª…ë ¹ì–´ëŠ” ìžì£¼ ì‚¬ìš©í•  ê±°ê¸° ë•Œë¬¸ì— package.jsonì— ì ì–´ë†“ìž

     ```json
     "scripts": {
         "dev": "nodemon --exec babel-node server",
         "migrate" : "npx prisma migrate dev" // ì¶”ê°€
       },
     ```

   ðŸ’¦ 1001ë²ˆ ì—ëŸ¬ì˜ ê²½ìš° database_urlì—ì„œ random passwordë„ ìž…ë ¥(pgadmin4ì˜ login/grouprolesì—ì„œ postgresì˜ property -> ë¹„ë°€ë²ˆí˜¸ ì„¤ì •) / ê·¸ê²ƒë„ ì•ˆë˜ë©´ ë°©í™”ë²½ì—ì„œ 5432í¬íŠ¸ ì—´ê¸° 

- ì™„ë£Œë˜ë©´ migrations í´ë” ìƒì„±ë¨
- ìœ„ì—ì„œì²˜ëŸ¼ devë¡œ ì‹¤í–‰í•œ ê²½ìš° ìžë™ìœ¼ë¡œ prisma client ê°€ ìƒì„±ë¨

### #3.6 Prisma Client

- prisma migrate ë¥¼ devë¡œ ì‹¤í–‰í•  ê²½ìš° client ìƒì„±ë¨
- client : ë°ì´í„°ë² ì´ìŠ¤ì™€ ì–´ë–»ê²Œ ë§í•˜ëŠ”ê°€
- node_modules/@prisma/clientì— clientê°€ ìžˆìŒ

1. **Client ìƒì„±**

```js
// server.js
import { PrismaClient } from "@prisma/client";

const client = new PrismaClient()
// ìš°ë¦¬ì˜ schemaì— ë§žì¶°ì„œ ìƒì„±ëœ client
```

2. **Client ì‚¬ìš©**

```js
// server.js

const resolvers = {
    Query : {
        movies : () => client.movie.findMany(), // dbë¡œ ê°€ì„œ ëª¨ë“  ì˜í™”ë“¤ì„ ê²€ìƒ‰
    },
    
    Mutation : { 
        createMovie : (_,{title,year,genre}) => 
            client.movie.create({data : { 
                title,  // title : title ì´ëž‘ ê°™ì€ ì˜ë¯¸
                year,
                genre,
            }}),
    }
```

- typeDefì—ì„œ createMovie() parameterì¶”ê°€í•´ì£¼ëŠ” ê²ƒë„ ìžŠì§€ë§ê³ , createëŠ” Movieë¥¼ ë¦¬í„´í•˜ê¸° ë•Œë¬¸ì—(createìœ„ì— ì»¤ì„œë¥¼ ì˜¬ë¦¬ë©´ í•¨ìˆ˜ ì„¤ëª… ë³¼ ìˆ˜ ìžˆìŒ) ë¦¬í„´íƒ€ìž…ë„ ë³€ê²½

```js
const typeDefs = gql`
 type Mutation {
        createMovie(title: String!) : Boolean // ì´ê±°ì—ì„œ
        deleteMovie(title:String!) : Boolean
    }
`;

const typeDefs = gql`
 type Mutation {
        createMovie(title: String!,year:Int!, genre:String) : Movie // ì´ë ‡ê²Œë³€ê²½
        deleteMovie(title:String!) : Boolean
    }
`;
```

- playground (localhost:4000) ì—ì„œ ì‹¤í–‰ì‹œì¼œë³´ê¸°

```
mutation {
  createMovie(title: "menuin", genre:"adventure",year:1999){
    title
    id
    createdAt
    updatedAt
    genre
  }
}

{
  movies{
    title
  }
}
```



### #3.7 Prisma client part 2

- Finding movie by id
  - whereëŠ” ì¡°ê±´ì„ ì˜ë¯¸

     ```js
     // typeDef ìˆ˜ì •
      type Query {
             movies : [Movie]
             movie(id:Int!) : Movie // ìˆ˜ì •
         }
     
     // resolver ìˆ˜ì •
     Query : {
             movies : () => client.movie.findMany(),
             movie : (_,{id}) => client.movie.findUnique({where:{id}}), // ìˆ˜ì •
         },
     ```

- Deleting movie by id
  - deleteMovieëŠ” ì‚­ì œí•œ Movieë¥¼ ë°˜í™˜í•´ì•¼í•¨

```js
// typeDef ìˆ˜ì •
 type Mutation {
        createMovie(title: String!,year:Int!, genre:String) : Movie
        deleteMovie(id:Int!) : Movie // ìˆ˜ì •      
    }

// resolver ìˆ˜ì •
Mutation : {
        deleteMovie : (_,{id}) => client.movie.delete({where : {id}}), // ìˆ˜ì •
            // {where : {id:id}} ì˜ short form
    }
```

- new mutation : update movie
  - whereëŠ” ì¡°ê±´, dataëŠ” ë°”ê¿€ ê°’

```js
// typeDef ì¶”ê°€
type Mutation {
        updateMovie(id:Int! year:Int!) : Movie
    }

// resolver ì¶”ê°€
 Mutation : {
     updateMovie : ({_,{id, year}) => client.movie.update({where:{id},data:{year}),
     // idê°€ ê°™ì€ movieì˜ yearë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë„£ì€ yearë¡œ êµì²´
    }
```

### #3.8 Prisma Studio

- Prisma Studio : ë°ì´í„°ë² ì´ìŠ¤ì— ìžˆëŠ” ëª¨ë¸ì„ ìœ„í•œ ë°ì´í„° **ë¸Œë¼ìš°ì €**(ë°ì´í„°ë² ì´ìŠ¤ ì‹œê°í™”) : ì•„ë¬´ê²ƒë„ ì„¤ì¹˜í•  í•„ìš”ê°€ ì—†ìŒ!!
-  **schema.prisma** íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë¨ (powerful file!)

- npx prisma studio 

ëª…ë ¹ì–´ ë‹¨ì¶•ì–´(?) ë¥¼ package.jsonì— ì¶”ê°€í•˜ìž

```json
"scripts": {
    "dev": "nodemon --exec babel-node server",
    "migrate" : "npx prisma migrate dev",
    "studio" : "npx prisma studio", // ì¶”ê°€
  },
```



### #3.9  Architecture part 1

- ì§€ê¸ˆ typeDef ì™€ resolver ê°€ ëª¨ë‘ í•œ íŒŒì¼ì— ìžˆìŒ!  -> it sucks!

- query ìž‘ì„±ì„ ìµœì í™” í•´ì£¼ìž : divide-conquer ë°©ì‹
- ë„ë©”ì¸ë³„ë¡œ ë‚˜ëˆ„ëŠ” ìž‘ì—…ì„ í†µí•´ : Movie íŒŒì¼ì„ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ê·¸ ì•ˆì— movie type, movie.resolvers, movie mutation, movie query  ë“±ì„ ì§‘ì–´ë„£ê¸°
- í•œ íŒŒì¼ì´ í•œê°€ì§€ ì¼ì„ í•˜ë„ë¡

```js
// client.js ì´ íŒŒì¼ì€ PrismaClientë¥¼ ì´ˆê¸°í™”í•´ì£¼ëŠ” ì¼ë§Œ í•˜ê²Œëœë‹¤

import { PrismaClient } from "@prisma/client";

const client = new PrismaClient();

export default client;
```



- schema ë„ ì˜®ê²¨ë³´ìž : schema = typeDef + resolvers

```js
// schema.js

import { gql } from "apollo-server";
import client from "./client";

export default gql`
type Movie {
    id : Int!
    title : String!
    year : Int!
    genre : String
    createdAt : String!
    updatedAt : String!
}
    type Query {
        movies : [Movie]
        movie(id:Int!) : Movie
    }

    type Mutation {
        createMovie(title: String!,year:Int!, genre:String) : Movie
        deleteMovie(id:Int!) : Movie
        updateMovie(id:Int! year:Int!) : Movie
        
    }
`;

export const resolvers = {
    Query : {
        movies : () => client.movie.findMany(),
        movie : (_,{id}) => client.movie.findUnique({where:{id}}),
    },
    Mutation : {
        createMovie : (_,{title,year,genre}) => 
            client.movie.create({data : {
                title,
                year,
                genre,
            }}),
        deleteMovie : (_,{id}) => client.movie.delete({where : {id}}),
        updateMovie : (_,{id, year}) => client.movie.update({where:{id},data:{year}}),
        
    }
};
```

```js
// server.js


import { ApolloServer, gql } from "apollo-server";
import { typeDefs, resolvers } from "./schema";


const server = new ApolloServer({
    typeDefs:typeDefs,
    resolvers:resolvers,
});

server.listen().then(() => console.log("Server is running on http://localhost:4000"));
```

- í•˜ì§€ë§Œ ì—¬ì „ížˆ schema.jsì— ë„ˆë¬´ ë§Žì€ ë‚´ìš©ë“¤ì´ ìžˆìŒ => í´ë”ë¥¼ ë§Œë“¤ìž

```js
// movies/movies.typeDefs.js
import { gql } from "apollo-server";

const typeDefs = gql`
type Movie {
    id : Int!
    title : String!
    year : Int!
    genre : String
    createdAt : String!
    updatedAt : String!
}
    type Query {
        movies : [Movie]
        movie(id:Int!) : Movie
    }

    type Mutation {
        createMovie(title: String!,year:Int!, genre:String) : Movie
        deleteMovie(id:Int!) : Movie
        updateMovie(id:Int! year:Int!) : Movie
        
    }
`;

```

```js
// movies/movies.queries.js
import client from "../client";
export default {
    Query : {
        movies : () => client.movie.findMany(),
        movie : (_,{id}) => client.movie.findUnique({where:{id}}),
    },
}
```

```js
// movies/movies.mutations.js

import client from "../client";
export default  {
    Mutation : {
        createMovie : (_,{title,year,genre}) => 
            client.movie.create({data : {
                title,
                year,
                genre,
            }}),
        deleteMovie : (_,{id}) => client.movie.delete({where : {id}}),
        updateMovie : (_,{id, year}) => client.movie.update({where:{id},data:{year}}),
        
    }
}
```

- ë‹¤ ì˜®ê²¨ì£¼ê³  ë‚˜ë©´ schema.js íŒŒì¼ì€ ë¹ˆ íŒŒì¼ì´ ë¨ => typeDefs ë¼ë¦¬ ëª¨ìœ¼ê³ , mutations ë¼ë¦¬ ëª¨ìœ¼ê³ , queries ë¼ë¦¬ ëª¨ì•„ì£¼ëŠ” ìž‘ì—…ì„ í•  ê²ƒìž„ => **graphql-tools** ì‚¬ìš©

### #3.10 Architecture part 2

- npm i graphql-tools
- ê³¼ì •
  1. íŒŒì¼ì„ ì°¾ëŠ”ë‹¤
     - pattern language : **ëŠ” ëª¨ë“  í´ë” ì•ˆ, *ì€ ëª¨ë“  íŒŒì¼ì„ ì˜ë¯¸

```js
// schema.js

import {loadFilesSync} from "graphql-tools";

const loadedTypes = loadFilesSync(`${__dirname}/**/*.typeDefs.js`)
// ëª¨ë“  í´ë”ì— ìžˆëŠ” íŒŒì¼ì„ ì°¾ì•„ì„œ ì•žì˜ ë¬¸ìžê°€ ë¬´ì—‡ì´ë˜ê°„ì— .typeDefs.jsë¡œ ëë‚˜ëŠ” ëª¨ë“  íŒŒì¼ì„ ì°¾ìŒ(movies.typeDefs.js ë‚˜ user.typeDefs.js ë“±)
const loadResolvers = loadFilesSync(`${__dirname}/**/*.{queries,mutations}.js`)
// queries.js ë¡œ ëë‚˜ê±°ë‚˜ (or) mutation.jsë¡œ ëë‚˜ëŠ” ê²ƒë“¤
```

2. ê·¸ íŒŒì¼ë“¤ì„ mergeí•¨

```js
import {loadFilesSync, mergeTypeDefs, mergeResolvers} from "graphql-tools";

const loadedTypes = loadFilesSync(`${__dirname}/**/*.typeDefs.js`)
const loadResolvers = loadFilesSync(`${__dirname}/**/*.{queries,mutations}.js`)

const typeDefs = mergeTypeDefs(loadedTypes);
const resolvers = mergeResolvers(loadResolvers); // merge
```

3. schemaë¥¼ ë§Œë“¦

```js
import { makeExecutableSchema } from "apollo-server";
import {loadFilesSync, mergeResolvers, mergeTypeDefs} from "graphql-tools";

const loadedTypes = loadFilesSync(`${__dirname}/**/*.typeDefs.js`)
const loadResolvers = loadFilesSync(`${__dirname}/**/*.{queries,mutations}.js`)

const typeDefs = mergeTypeDefs(loadedTypes);
const resolvers = mergeResolvers(loadResolvers);


const schema = makeExecutableSchema({typeDefs,resolvers}) // schema ë§Œë“¬

export default schema;
```

4. server.jsëŠ” ì´ë ‡ê²Œ ë³€í•¨

```js

import { ApolloServer } from "apollo-server";
import schema from "./schema";


const server = new ApolloServer({
    schema,
});

server.listen().then(() => console.log("Server is running on http://localhost:4000"));
```

