# 7/5

### #4.7 updateProfile

- ì–´ë–¤ userì˜ profileì„ ì—…ë°ì´íŠ¸í•  ê±´ì§€ì— ëŒ€í•´ì„œëŠ” ë‹¤ìŒì‹œê°„ì— (#4.8ì—ì„œ)
- ì¼ë‹¨ ì—¬ê¸°ì„œëŠ” id:1 ì¸ userë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¡°ê±´ì„ ê²€

```js
// editProfile.resolvers.js

import client from "../../client";

export default {
    Mutation : {
        editProfile : (_,{firstName, lastName, username, email, password}) => {
            return client.user.update({
            where:{  // id:1 ì¸ ìœ ì € ì—…ë°ì´íŠ¸
                id:1,
            }, 
            data:{
                firstName, 
                lastName, 
                username, 
                email, 
                password
            }})
        }
    }
}
```

- firstName, lastName, username.... ì¤‘ ì›í•˜ëŠ” ê²ƒë§Œ ë°”ê¿€ê±°ë‹ˆê¹Œ ì „ë¶€ë‹¤ required(!) í•´ì œ

```js
// editProfile.typeDefs.js

import {gql} from "apollo-server"

export default gql`

type EditProfileResult {
    ok : Boolean!
    error : String
}

type Mutation {
    editProfile( 
        firstName:String
        lastName : String
        username : String
        email : String
        password : String
    ) : EditProfileResult
}
`
```

ðŸ“Œ prismaì—ê²Œ undefinedëœ ê°’ì„ ì—…ë°ì´íŠ¸í•˜ë¼ê³  í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

```
// playground
mutation {
  editProfile (email : "menuin@gmail.com"){
  	ok
    error
  }
}
```

- ì´ ê²½ìš° emailì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ (firstName, lastName...) ê°’ì€ ëª¨ë‘ undefined ë¡œ ë„˜ì–´ê°

  => email ë§Œ ìž˜ ë°”ë€Œì—ˆìŒ 

  => â­**prismaì— undefinedë¥¼ ë³´ë‚´ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— ê·¸ ê°’ë“¤ì„ ë³´ë‚´ì§€ ì•ŠìŒ!**â­



ðŸ“Œ passwordë„ ì—…ë°ì´íŠ¸í•˜ë ¤ë©´ hashí•œ ê°’ì„ ë³´ë‚´ì•¼ í•œë‹¤ 

- passwordë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ ìž í•œë‹¤ë©´ hash (uglyPassword)

- passwordë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ ìž í• ë•Œë§Œ hashí•œ new passwordë¥¼ dataì— ë‹´ì•„ ë³´ë‚¸ë‹¤

   `...(uglyPassword && {password:uglyPassword})`

  - uglyPasswordê°€ trueì´ë©´ `{password:uglyPassword}` ì´ ë¼ì¸ì´ ìœ íš¨.

  - `...` ì€ â­â­ ES6 ë¬¸ë²•ìœ¼ë¡œ curly bracesë¥¼ ì‚­ì œí•´ì¤Œ. ì¦‰ uglyPasswordê°€ trueì´ë©´ ì € ë¼ì¸ì´ ìžˆë˜ ìžë¦¬ì— `password:uglyPassword`ë§Œ ë‚¨ê²Œë¨.

```js
// editProfile.resolvers.js

import client from "../../client";
import bcrypt from "bcrypt";

export default {
    Mutation : {
        editProfile : async (_,{firstName, lastName, username, email, password:newPassword}) => { // passwordë¥¼ newPasswordë¡œ rename(ì´ ë¸”ëŸ­ ì•ˆì—ì„œ)
            let uglyPassword = null;
            if (newPassword){ // passwordë¥¼ ìˆ˜ì •í•˜ê³ ìž í•œë‹¤ë©´,
                uglyPassword = await bcrypt.hash(newPassword, 10);
            }

            const updatedUser = await client.user.update({
                // client.user.update ëŠ” Userë¥¼ ë¦¬í„´í•œë‹¤
            where:{
                id:1,
            }, 
            data:{
                firstName, 
                lastName, 
                username, 
                email, 
                // ES6 ë¬¸ë²•!!
                ...(uglyPassword && {password:uglyPassword}),
            }})
            
            // editProfileì€ EditProfileResult ë¥¼ ë¦¬í„´
            if (updatedUser.id){
                return {
                    ok:true
                }
            } else {
                return {
                    ok:false,
                    error : "Could not update profile."
                }
            }
            
        }
    }
}
```

ðŸ’¦ awaitë¥¼ ì“°ë©´ asyncë¥¼ ê¼­ ê°™ì´ ë¶™ì´ê¸°!!



### #4.8 Authentication Part 1

- login : ìœ ì €ì—ê²Œ í† í°ì„ ì¤Œ

  => ìœ ì €ê°€ operation ì„ í•  ë•Œë§ˆë‹¤ í† í°ì„ ë³´ë‚´ì•¼ í•œë‹¤ (ìœ ì €ê°€ ëˆ„êµ°ì§€ ìš°ë¦¬ê°€ í™•ì¸í•´ì•¼ í•˜ë‹ˆê¹Œ)

- editProfileì— í† í°ì„ ê²€ì‚¬í•˜ëŠ” ê³¼ì •ì„ ì¶”ê°€í•˜ê² ìŒ

```js
// editProfile.typeDefs.js

type Mutation {
    editProfile(
        firstName:String
        lastName : String
        username : String
        email : String
        password : String
        token : String!     // ì¶”ê°€ (required)
    ) : EditProfileResult
}
```

- `jwt.verify(token, SECRET_KEY)` : **ìš°ë¦¬ê°€ ì´ í† í°ì„ ë§Œë“¤ì—ˆê³  / ì´ í† í°ì´ ë³€í˜•ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ê²ƒì„ í™•ì¸**

```js
// editProfile.resolvers.js
import jwt from "jsonwebtoken";
...
editProfile : async (_,{firstName, lastName, username, email, password:newPassword, token}) => {
	const verifiedToken = await jwt.verify(token, process.env.SECRET_KEY)
    console.log(verifiedToken) // id ê°’ê³¼ token ì†ì„±ì„ ê°€ì§„ object ì¶œë ¥
```

=> â­ ì¦‰ í† í°ì„ ë³´ë‚¸(í”„ë¡œí•„ì„ ì—…ë°ì´íŠ¸í•˜ê³ ìž í•˜ëŠ”) USERì˜ IDë¥¼ ì´ëŸ°ì‹ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ìžˆìŒ(ES6) :   `const { id } = await jwt.verify(token, process.env.SECRET_KET)`

=> **opening a object(ES6)**

- update ì¡°ê±´ë„ ìˆ˜ì •

```js
where:{
	id
}, 
```





### #4.9 Authentication part 2

ðŸ“Œ ëª¨ë“  mutationê³¼ queryì— í† í°ì„ ì œê³µí•˜ê³  verifyí•˜ëŠ” ê³¼ì •ì„ ë°˜ë³µí•˜ëŠ” ê±´ ë„ˆë¬´ ê·€ì°®ë‹¤!

ðŸ‘€ PART 1 : **tokenì„ ìžë™ìœ¼ë¡œ ë³´ë‚´ëŠ” ë²•ì„ ì°¾ì•„ì•¼ í•œë‹¤** => **http header** ì‚¬ìš© (í—¤ë”ëŠ” ëª¨ë“  requestì— ìžë™ìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤)

- playground í•˜ë‹¨ì— QUERY VARIABLES HTTP HEADERS ì¹¸ì— ì ìœ¼ë©´ ë¨

  ```
  {
    "token" : "í† í° ë³µë¶™"
  }
  ```

  + í† í°ì€ loginì„ ì‹¤í–‰í•´ì„œ í™•ì¸í•  ìˆ˜ ìžˆë‹¤

ðŸ‘€ PART 2 : í—¤ë”ì˜ í† í°ì„ editProfile(ê³¼ ë‹¤ë¥¸ resolvers)ê¹Œì§€ ë‹¤ë‹¤ë¥´ê²Œ í•˜ê¸°

- graphql ìˆ˜ì—…ì—ì„œë„ ë‹¤ë¤˜ì—ˆëŠ”ë°, editProfile í•¨ìˆ˜ì—ëŠ” **4ê°€ì§€ argument**ê°€ ìžˆìŒ! **(root, args, context, info)**

- â­**context** : **ëª¨ë“  resolverì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì •ë³´**ë¥¼ ë„£ì„ ìˆ˜ ìžˆëŠ” object

  => ìš°ë¦¬ê°€ ë³´ë‚´ëŠ” í† í°ì„ contextì— ë„£ì–´ì£¼ë©´ ëª¨ë“  resolverì— ê·¸ í† í°ì„ ë³´ë‚´ëŠ” ê²ƒì´ë‚˜ ë‹¤ë¦„ ì—†ë‹¤

  => ê·¸ë ‡ë‹¤ê³  editProfileì˜ argumentì—ë§Œ contextë¥¼ ë„£ê³  ê·¸ ì•ˆì—ì„œ context.token ìœ¼ë¡œ ì¨ë¨¹ëŠ” ê±°ëŠ” ì•ˆë¨., ë‹¤ë¥¸ resolverì—ì„œëŠ” context.tokenìœ¼ë¡œ ë¶€ë¥¼ ìˆ˜ ì—†ê¸°ë•Œë¬¸ (argumentì— contextê°€ ì•ˆë“¤ì–´ê°€ë‹ˆê¹Œ)

  => **ëˆ„ê°€ ì´ graphqlì„ ìƒì„±í•˜ëŠ”ê°€? : apollo server** 

  â€‹	ì•„í´ë¡œ ì„œë²„ëŠ” context íŒŒíŠ¸ê°€ ìžˆë‹¤!!

  ```js
  // server.js
  const server = new ApolloServer({
      schema,
      context : { // objectë¡œ ë³´ëƒ„
          "token" : "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiaWF0IjoxNjI1NTExMDQ0fQ.Eu-26qieSbC5m_mYPMaXA8_UFjOqizSn3DRuN1M7fi0"   
      } // ì´ë ‡ê²Œ í•˜ë©´ ëª¨ë“  resolverë¡œ contextë¡œì¨ ì „ë‹¬ëœë‹¤
  });
  ```

```js
// editProfile.resolvers.js

editProfile : async (_,{firstName, lastName, username, email, password:newPassword},{token}) => { 
    // contextì—ì„œ token êº¼ëƒ„ (opening object-ES6)
	const {id} = await jwt.verify(token, process.env.SECRET_KEY);
```

- ì•„ì§ http headerì™€ contextë¥¼ ì—°ê²°í•˜ê³  ìžˆì§€ëŠ” ì•ŠìŒ 
- contextëŠ” objectë„ ë  ìˆ˜ ìžˆì§€ë§Œ, functionë„ ë  ìˆ˜ ìžˆë‹¤.



### #4.10 Authentication part 3

- http headerë¥¼ ì‚¬ìš©í•´ì„œ contextë¡œ í† í° ë³´ë‚´ê¸°

```js
// server.js

const server = new ApolloServer({
    schema,
    context : ({req}) => {
        console.log(req.headers); // tokenë„ ì°í˜€ì„œ ë‚˜ì˜´
        return {
            token :
                req.headers.token, 
        };
    }
});
```

- ì•„ì§ë„ resolver ë§ˆë‹¤ `const {id} = await jwt.verify(token, process.env.SECRET_KEY);` ì´ ì½”ë“œë¥¼ ìž‘ì„±í•´ì•¼ í•¨ >> **í† í°ì„ ë³´ë‚´ëŠ” ê²ƒ ëŒ€ì‹  Contextì—ì„œ ë¯¸ë¦¬ USERë¥¼ ì°¾ì•„ì„œ USERë¥¼ ë³´ë‚´ëŠ” ê±´ ì–´ë–¨ê¹Œ?**

1. tokenì„ ì´ìš©í•´ì„œ userë¥¼ êµ¬í•˜ëŠ” ìƒˆë¡œìš´ function

```js
// users/users.utils.js

import jwt from "jsonwebtoken";
import client from "../client";

export const getUser = async(token) => {
    try{
        if (!token){ // tokenì´ ì—†ë‹¤ë©´ user = null
            return null;
        }
        const {id} = await jwt.verify(token, process.env.SECRET_KEY);
        const user = await client.user.findUnique({where: {id}});

        if (user){
            return user;
        } else {
            return null;
        }
    } catch {
        return null;
    }
}
```

2. contextê°€ loggedInUserë¥¼ ë¦¬í„´í•˜ë„ë¡ ìˆ˜ì •
   - await ì“°ëŠ”ê±° ìžŠì§€ x

```js
// server.js


const server = new ApolloServer({
    schema,
    context : async ({req}) => {
        return {
            loggedInUser :
                await getUser(req.headers.token),    
        };
    }
```

3. resolver ìˆ˜ì •

```js
editProfile : async (_,{firstName, lastName, username, email, password:newPassword},{loggedInUser}) => {  // ìˆ˜ì •
            console.log(loggedInUser);

            let uglyPassword = null;
            if (newPassword){
                uglyPassword = await bcrypt.hash(newPassword, 10);
            }

            const updatedUser = await client.user.update({
            where:{
                id:loggedInUser.id,  // ìˆ˜ì •
            }, 
            data:{
                firstName, 
                lastName, 
                username, 
                email, 
                ...(uglyPassword && {password:uglyPassword}),
            }});
```

