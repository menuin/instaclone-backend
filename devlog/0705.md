# 7/5

### #4.7 updateProfile

- μ–΄λ–¤ userμ profileμ„ μ—…λ°μ΄νΈν•  κ±΄μ§€μ— λ€ν•΄μ„λ” λ‹¤μμ‹κ°„μ— (#4.8μ—μ„)
- μΌλ‹¨ μ—¬κΈ°μ„λ” id:1 μΈ userλ¥Ό μ—…λ°μ΄νΈν•λ” κ²ƒμΌλ΅ μ΅°κ±΄μ„ κ²€

```js
// editProfile.resolvers.js

import client from "../../client";

export default {
    Mutation : {
        editProfile : (_,{firstName, lastName, username, email, password}) => {
            return client.user.update({
            where:{  // id:1 μΈ μ μ € μ—…λ°μ΄νΈ
                id:1,
            }, 
            data:{
                firstName, 
                lastName, 
                username, 
                email, 
                password
            }})
        }
    }
}
```

- firstName, lastName, username.... μ¤‘ μ›ν•λ” κ²ƒλ§ λ°”κΏ€κ±°λ‹κΉ μ „λ¶€λ‹¤ required(!) ν•΄μ 

```js
// editProfile.typeDefs.js

import {gql} from "apollo-server"

export default gql`

type EditProfileResult {
    ok : Boolean!
    error : String
}

type Mutation {
    editProfile( 
        firstName:String
        lastName : String
        username : String
        email : String
        password : String
    ) : EditProfileResult
}
`
```

π“ prismaμ—κ² undefinedλ κ°’μ„ μ—…λ°μ΄νΈν•λΌκ³  ν•λ©΄ μ–΄λ–»κ² λ κΉ?

```
// playground
mutation {
  editProfile (email : "menuin@gmail.com"){
  	ok
    error
  }
}
```

- μ΄ κ²½μ° emailμ„ μ μ™Έν• λ‚λ¨Έμ§€ (firstName, lastName...) κ°’μ€ λ¨λ‘ undefined λ΅ λ„μ–΄κ°

  => email λ§ μ λ°”λ€μ—μ 

  => β­**prismaμ— undefinedλ¥Ό λ³΄λ‚΄λ©΄ λ°μ΄ν„°λ² μ΄μ¤μ— κ·Έ κ°’λ“¤μ„ λ³΄λ‚΄μ§€ μ•μ!**β­



π“ passwordλ„ μ—…λ°μ΄νΈν•λ ¤λ©΄ hashν• κ°’μ„ λ³΄λ‚΄μ•Ό ν•λ‹¤ 

- passwordλ¥Ό μ—…λ°μ΄νΈν•κ³ μ ν•λ‹¤λ©΄ hash (uglyPassword)

- passwordλ¥Ό μ—…λ°μ΄νΈν•κ³ μ ν• λ•λ§ hashν• new passwordλ¥Ό dataμ— λ‹΄μ•„ λ³΄λ‚Έλ‹¤

   `...(uglyPassword && {password:uglyPassword})`

  - uglyPasswordκ°€ trueμ΄λ©΄ `{password:uglyPassword}` μ΄ λΌμΈμ΄ μ ν¨.

  - `...` μ€ β­β­ ES6 λ¬Έλ²•μΌλ΅ curly bracesλ¥Ό μ‚­μ ν•΄μ¤. μ¦‰ uglyPasswordκ°€ trueμ΄λ©΄ μ € λΌμΈμ΄ μλ μλ¦¬μ— `password:uglyPassword`λ§ λ‚¨κ²λ¨.

```js
// editProfile.resolvers.js

import client from "../../client";
import bcrypt from "bcrypt";

export default {
    Mutation : {
        editProfile : async (_,{firstName, lastName, username, email, password:newPassword}) => { // passwordλ¥Ό newPasswordλ΅ rename(μ΄ λΈ”λ­ μ•μ—μ„)
            let uglyPassword = null;
            if (newPassword){ // passwordλ¥Ό μμ •ν•κ³ μ ν•λ‹¤λ©΄,
                uglyPassword = await bcrypt.hash(newPassword, 10);
            }

            const updatedUser = await client.user.update({
                // client.user.update λ” Userλ¥Ό λ¦¬ν„΄ν•λ‹¤
            where:{
                id:1,
            }, 
            data:{
                firstName, 
                lastName, 
                username, 
                email, 
                // ES6 λ¬Έλ²•!!
                ...(uglyPassword && {password:uglyPassword}),
            }})
            
            // editProfileμ€ EditProfileResult λ¥Ό λ¦¬ν„΄
            if (updatedUser.id){
                return {
                    ok:true
                }
            } else {
                return {
                    ok:false,
                    error : "Could not update profile."
                }
            }
            
        }
    }
}
```

π’¦ awaitλ¥Ό μ“°λ©΄ asyncλ¥Ό κΌ­ κ°™μ΄ λ¶™μ΄κΈ°!!



### #4.8 Authentication Part 1

- login : μ μ €μ—κ² ν† ν°μ„ μ¤

  => μ μ €κ°€ operation μ„ ν•  λ•λ§λ‹¤ ν† ν°μ„ λ³΄λ‚΄μ•Ό ν•λ‹¤ (μ μ €κ°€ λ„κµ°μ§€ μ°λ¦¬κ°€ ν™•μΈν•΄μ•Ό ν•λ‹κΉ)

- editProfileμ— ν† ν°μ„ κ²€μ‚¬ν•λ” κ³Όμ •μ„ μ¶”κ°€ν•κ² μ

```js
// editProfile.typeDefs.js

type Mutation {
    editProfile(
        firstName:String
        lastName : String
        username : String
        email : String
        password : String
        token : String!     // μ¶”κ°€ (required)
    ) : EditProfileResult
}
```

- `jwt.verify(token, SECRET_KEY)` : **μ°λ¦¬κ°€ μ΄ ν† ν°μ„ λ§λ“¤μ—κ³  / μ΄ ν† ν°μ΄ λ³€ν•λμ§€ μ•μ•λ‹¤λ” κ²ƒμ„ ν™•μΈ**

```js
// editProfile.resolvers.js
import jwt from "jsonwebtoken";
...
editProfile : async (_,{firstName, lastName, username, email, password:newPassword, token}) => {
	const verifiedToken = await jwt.verify(token, process.env.SECRET_KEY)
    console.log(verifiedToken) // id κ°’κ³Ό token μ†μ„±μ„ κ°€μ§„ object μ¶λ ¥
```

=> β­ μ¦‰ ν† ν°μ„ λ³΄λ‚Έ(ν”„λ΅ν•„μ„ μ—…λ°μ΄νΈν•κ³ μ ν•λ”) USERμ IDλ¥Ό μ΄λ°μ‹μΌλ΅ ν‘ν„ν•  μ μμ(ES6) :   `const { id } = await jwt.verify(token, process.env.SECRET_KET)`

=> **opening a object(ES6)**

- update μ΅°κ±΄λ„ μμ •

```js
where:{
	id
}, 
```

π“ λ¨λ“  mutationμ— ν† ν°μ„ μ κ³µν•κ³  verifyν•λ” κ³Όμ •μ„ λ°λ³µν•λ” κ±΄ λ„λ¬΄ κ·€μ°®λ‹¤!