#  ğŸ‘» DEVLOG 7/12

### #6.14 See photo comments

- photos.typeDefs ì— comment(numOfComments, to be exact) ì¶”ê°€ (type Photo) 

  `comments : Int!`

- photos.resolvers >> comments

- seePhotosCommentë¥¼ comments  í´ë” ë‚´ì— ë§Œë“¤ì§€ photos í´ë” ë‚´ì— ë§Œë“¤ì§€ >> ëª¨ë¸ë§ ë¬¸ì œ



**without pagination** - ë°ì´í„°ë² ì´ìŠ¤ì— ë¶€í•˜

```js
// seePhotoComments.resolvers
seePhotoComments: (_, { id }) => client.photo.findUnique({
            where: {
                id,
            },
        }).Comment(),
```

**with pagination**

```js
 seePhotoComments: (_, { id }) => client.comment.findMany({
            where: {
                photoId: id,
            },
     		skip: ~
     		take : ~
            orderBy: {
                createdAt: "asc",
            }
        })
```

- ì™œ êµ³ì´ seePhotoCommentsë¥¼ ë§Œë“¤ì—ˆëŠ”ê°€ (seePhotoLikesë„ ë§ˆì°¬ê°€ì§€)

  ```js
  seePhoto { // ì´ë ‡ê²Œ í™•ì¸í•  ìˆ˜ë„ ìˆìŒ
      comments (page:1){
          id
          caption
      }
  }
  ```

  - ì¸ìŠ¤íƒ€ê·¸ë¨ì—ì„œ commentëŠ” ì‚¬ì§„ì„ ë³´ì—¬ì£¼ëŠ” í˜ì´ì§€ì™€ ë‹¤ë¥¸ í˜ì´ì§€ì„(ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ë„˜ì–´ê°) -> ë˜ë‹¤ë¥¸ resolverê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒìœ¼ë¡œ íŒë‹¨
  - í•œ í™”ë©´ì—ì„œ ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´ typeDefsì— `comments : [Comment]`ë¼ê³  ì ì—ˆì„ê²ƒì„



### #6.15 isMine

- loggedInUserëŠ” nullì¸ ê²½ìš°ê°€ ìˆê¸° ë•Œë¬¸ì—(ë¡œê·¸ì¸ì•ˆí–ˆì„ê²½ìš°) í•­ìƒ ë¶„ê¸°ë¥¼ í•´ì¤˜ì•¼í•¨

```js
// photos.resolvers
isMine: ({ userId }, _, { loggedInUser }) => {
            if (!loggedInUser) {
                return false;
            }
            return userId === loggedInUser.id;
        }
```

- comments.resolversì—ë„ ë¶™ì—¬ë„£ê¸°

### #6.16 Delete comment and photos

- deletePhoto
  1. photoê°€ ì—†ì„ ê²½ìš° > error
  2. ì‚­ì œí•˜ë ¤ëŠ” photoì˜ ì£¼ì¸(userId)ì´ ë¡œê·¸ì¸í•œ ìœ ì €ì™€ ë¶ˆì¼ì¹˜(loggedInUser.id) > error
  3. else > delete
- deleteCommentë„ ë¹„ìŠ·



### #6.17 editComment & MutationResponse

- editComment.resolvers/typeDefs  ì½”ë“œ í™•ì¸

- í•œê°€ì§€ ë¶ˆí¸í•œì : `ok:Boolean! error:String`ì„ ë°˜ë³µí•˜ê³  ìˆìŒ

  - DeleteCommentResultë‚˜ editCommentResult ë‚˜ ëª¨ë“  Resultì˜ ë‚´ìš©ë¬¼ì´ ë˜‘ê°™ê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ mutation responseë¥¼ ìƒì„±

  ```js
  // shared/shared.typeDefs.js
  import { gql } from "apollo-server";
  
  export default gql`
      type MutationResponse {
          ok:Boolean!
          error : String
      }
  `
  ```

- graphql combines all types, so you don't need to import `MutationResponse`

```js
// deleteComment.typeDefs

type Mutation {
        deleteComment(id:Int!) : MutationResponse!
    }
```

- ë‹¤ë¥¸ íŒŒì¼ë“¤ë„ ìˆ˜ì •



### #6.18 protectedResolver Refactor

**query resolver ë³´í˜¸ > info argument ì‚¬ìš©í•˜ê¸°**

- protectedResolver : ìš°ë¦¬ê°€ í•˜ëŠ” mutation, query ë“¤ì„ ê°€ë¡œì±„ì„œ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ë‹¤ë©´ errorë¥¼ ì‘ë‹µ (protecting our resolver)

- ë¬¸ì œ : seeFeedë¥¼ ì œì™¸í•œ ëŒ€ë¶€ë¶„ì˜ queryë“¤ì€ not protected(public). if seeFeed is protected, it should return ok/error when user is not logged in - but in seeFeed.typeDefs, it doesnt say that seeFeed sometimes returns ok/error
- ë¡œê·¸ì¸ ì•ˆí•œ ìƒíƒœë¡œ seeFeedí•˜ë©´ ì—ëŸ¬ë‚¨

```js
// seeFeed.typeDefs
type Query {
    seeFeed : [Photo]  // ok/errorë¥¼ ë¦¬í„´í•˜ëŠ”ì§€ ì•Œìˆ˜ì—†ìŒ
}
```

+ í•´ê²° : **info** argument ì— ë‹´ê¸´ ì •ë³´(ì¤‘ operaration) can check if the user is sending query, or mutation

```js
// users.utils.js > protectedResolver
if (!context.loggedInUser){
    // loginì´ ì•ˆë˜ì–´ìˆëŠ”ë° userê°€ í•˜ê³ ìˆëŠ” operationì´ queryë©´ return null
            const query = info.operation.operation === "query"
            if (query){
                return null;
            } else {
                return {
                    ok :false,
                    error: "Please log in to perform this action."
                }
            }
        }
```



### #6.19 S3 Photo upload

- photoë¥¼ ì„œë²„ì— ì €ì¥í•˜ëŠ” ëŒ€ì‹  aws ì €ì¥ì†Œì— ì—…ë¡œë“œí•˜ê¸°
  - ì„œë²„ë¥¼ ëŒ ë•Œ íŒŒì¼ì´ ê°™ì´ ì—†ì–´ì§€ê¸° ë•Œë¬¸

- npm i aws-sdk

- aws ê³„ì •ë§Œë“¤ê¸°

- ì—…ë¡œë“œí•˜ê¸° ìœ„í•œ api í‚¤

- aws-IAM-IAM resources-Users(ì‚¬ìš©ì)-ì‚¬ìš©ìì¶”ê°€(í”„ë¡œê·¸ë˜ë°ë°©ì‹)-ê¸°ì¡´ì •ì±…ì§ì ‘ì—°ê²°-AmazonS3FullAccess-ê¸°íƒ€ì„¤ì •ìŠ¤í‚µí•˜ê³  ì‚¬ìš©ì ë§Œë“¤ê¸° 

- secret access keyëŠ” ë”± í•œë²ˆë§Œ ë³´ì—¬ì¤Œ - .envì— ì ì–´ë†“ê¸°

  ```js
  AWS_KEY = ...
  AWS_SECRET = ...
  ```

- Console-S3-Create bucket-í¼ë¸”ë¦­ì•¡ì„¸ìŠ¤í—ˆìš©

- awsëŠ” ëª¨ë“  ê²ƒì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” apií‚¤ë¥¼ ë§Œë“¤ì§€x , íŠ¹ì •ì„œë¹„ìŠ¤ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” apií‚¤



- aws ë¡œê·¸ì¸

```js
// create shared/shared.utils.js 

import AWS from "aws-sdk";

AWS.config.update({
    credentials:{
        accessKeyId : process.env.AWS_KEY,
        secretAccessKey:process.env.AWS_SECRET,
    }
})
```



### #6.20 S3 Photo Upload part 2

- uploadPhotoê°€ aws ë‚´ ì´ë¯¸ì§€ì˜ urlì„ ë¦¬í„´ -> avatarUrlì— ì €ì¥

- ê¸°ì¡´ë°©ì‹ (ì„œë²„ì— íŒŒì¼ ì—…ë¡œë“œ) - ì£¼ì„ì²˜ë¦¬

```js
avatarUrl = await uploadPhoto(avatar, loggedInUser.id) // ì¶”ê°€

// editProfile.resolvers
// const { filename, createReadStream } = await avatar;
// const newFilename = `${loggedInUser.id}-${Date.now()}-${filename}`;
// const readStream = createReadStream();
// const writeStream = fs.createWriteStream(process.cwd() + "/uploads/" + newFilename);
// readStream.pipe(writeStream);
// avatarUrl = `http://localhost:4000/static/${newFilename}`;
```

- awsì— ì—…ë¡œë“œ
  - callback function ì„ ì“°ê±°ë‚˜ 
  - await ì‚¬ìš© -> ëì— .promise()ë¥¼ ì¨ì•¼í•¨

```js
// shared.utils.js

export const uploadPhoto = async (file,userId) => {
    const {filename,createReadStream} = await file;
    const readStream = createReadStream();

    const objectName = `${userId}-${Date.now()}-${filename}`
    const upload = await new AWS.S3().upload({ // S3 ê°ì²´ ìƒì„±
        Bucket : "uploads-instaclone",  // Bucket ì´ë¦„
        Key : objectName,   // íŒŒì¼ ì´ë¦„
        ACL : "public-read",  // objectì˜ í”„ë¼ì´ë²„ì‹œ
        Body : readStream, // file (stream)
    }).promise();
    
    console.log(upload); // Location í•„ë“œì— urlì‡ìŒ
    // uploadPhotoëŠ” urlì„ ë°˜í™˜í•´ì•¼í•¨
    return upload.Location;
}
```

- ì´ë ‡ê²Œ ì“°ë˜ê°€

```js
const {Location} = await new AWS.S3 ~
      ...
return Location;
```



### #6.21 Photo Upload part 3

- shared.utils.jsì˜ uploadPhoto -> uploadToS3 ë¡œ ë³€ê²½

- uploadPhotoë„ ìˆ˜ì •

  - file : String -> file : Upload (uploadPhoto.typeDefs.js)

  - -

    ```js
    // uploadPhoto.resolvers.js
    
    const fileUrl = await uploadToS3(file, loggedInUser.id);
    ```

    

- resolverë³„ë¡œ í´ë” ë¶„ê¸°í•˜ê¸° => objectNameì— í´ë”ëª… ì¶”ê°€
  - editProfile ì—ì„œ ì—…ë¡œë“œëœ íŒŒì¼ì€ avatar/ ì—
  - uploadPhoto ì—ì„œ ì—…ë¡œë“œëœ íŒŒì¼ì€ uploads/ ì—

```js
// shared.utils.js
    const objectName = `${folderName}/${userId}-${Date.now()}-${filename}`

// editProfile.resolvers
avatarUrl = await uploadToS3(avatar, loggedInUser.id, "avatars")

// uploadPhoto.resolvers
const fileUrl = await uploadToS3(file, loggedInUser.id, "uploads");

```

ğŸ’¦ altairì—ì„œ ì‹¤í–‰í•´ë„ argumentë¡œ ì…ë ¥ëœ avatarê°€ nullì´ ë˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆëŠ”ë°

```js
mutation($file:Upload){
  editProfile(avatar: $file) {
    ok
    error
  }
}
// editProfileì—ì„œ console.log(avatar) í•˜ë©´ null
```

- select file í•˜ê³  íŒŒì¼ì´ë¦„ì„ $file << ì—¬ê¸°ë“¤ì–´ê°€ëŠ” ì´ë¦„ìœ¼ë¡œ ë§ì¶°ì¤˜ì•¼í•˜ëŠ” ê²ƒ ê°™ìŒ

