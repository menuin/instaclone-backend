# ğŸŒŠ DEVLOG 7/11

### #6.6 seeHashtag

```js
// playground 
{
  seeHashtag(hashtag:"#food"){
    photos { // relation field(?)
      file
      id
    }
    totalPhotos // computed field
  }
}
```

â“ photos í•„ë“œë„ computed field ë¼ê³  í•¨? ëª¨ë¥´ê²Ÿë‹¤

- photos, totalPhotosì˜ resolverê°€ í•„ìš”í•œë° photos.resolver ì•ˆì— ì¨ì¤„ ìˆ˜ ìˆìŒ

1. **totalPhotos**

```js
// photos.resolversì— ì¶”ê°€
 Hashtag: {
        totalPhotos: ({ id }) => client.photo.count({
            where: {
                hashtags: {
                    some: {
                        id,
                    }
                }
            }
        })
    }
// photo ì¤‘ ê·¸ hashtagsì— parentì˜ idì™€ ê°™ì€ idì˜ hashtagê°€ ìˆëŠ” photoë¥¼ ëª¨ë‘ count
```

â­â­ query ì™¸ì—, Hashtag ê°™ì€ type ì•ˆì—ì„œ resolver fieldã„¹ë¥´ ì‘ì„±í• ë•ŒëŠ” parent(root)ë¥¼ ê¼­ê¼­ ì¨ì¤˜ì•¼í•¨~



2. **photos**

â­ new! â­ **í•„ë“œ ì†ì— argument ë„£ì„ìˆ˜ìˆë‹¤**

```js
// pg
{
  seeHashtag(hashtag:"#food"){
    photos (page:1) { // ì´ë ‡ê²Œ
      file
      id
    }
  }
}

// photos.typeDefs
type Hashtag {
    photos(page:Int!): [Photo] // ìˆ˜ì •
}
```

- seeHashtag.resolvers/typeDefs ì— argumentë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ ë¨



### #6.7 editPhoto part 1

- user íƒ€ì…ì—ë„ photos:[Photo] ì¶”ê°€ / users.resolversì—ë„ ì¶”ê°€
- searchPhoto : check out the code
- editPhoto
  - findUnique()ëŠ” ì¡°ê±´ì´ ê³ ìœ ì†ì„±ì¸ ê²½ìš°ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ => userIdë¡œ ì°¾ê¸°ìœ„í•´ findFirst() ì‚¬ìš©

```js
// editPhoto.resolvers
editPhoto: protectedResolver(async (_, { id, caption }, { loggedInUser }) => {
            const ok = await client.photo.findFirst({
                where: {
                    id,
                    userId: loggedInUser.id,
                },
            });
            if (!ok) {
                return {
                    ok: false,
                    error: "Photo not found"
                }
            }
    
            const photo = await client.photo.update({
                where: {
                    id
                },
                data : {
                    caption,
                }
            });
        }),
```

+ mutationì˜ ê²½ìš° return Result typeì„ ë§Œë“œëŠ”ê²Œ ì¢‹ì€ ê²ƒ ê°™ë‹¤ëŠ” ë‹ˆê¼¬ì˜ ìƒê°



### #6.8 editPhoto part 2

- captionì„ ì—…ë°ì´íŠ¸í•´ë„ hashtagë“¤ì€ ì´ì „ ê²ƒ ê·¸ëŒ€ë¡œë¼ëŠ” ë¬¸ì œê°€ ìˆìŒ

1. oldPhotoì—ì„œ ê¸°ì¡´ì˜ í•´ì‹œíƒœê·¸ë“¤ì„ ë°›ì•„ ëª¨ë‘ disconnect

```js
const oldPhoto = await client.photo.findFirst({
                where: {
                    id,
                    userId: loggedInUser.id,
                },
                inclue : {
                    hashtags : { 
                        // hashtags:true í•˜ë©´ ëª¨ë“  ì •ë³´ë¥¼ ë‹¤ë°›ì•„ì˜¤ë‹ˆê¹Œ ì´ë ‡ê²Œí•¨
                        select : {
                            hashtag : true,
                        }
                    }
                }
            });
...
const photo = await client.photo.update({
                where: {
                    id
                },
                data: {
                    caption,
                    hashtags: { // disconnect
                        disconnect: oldPhoto.hashtags,
                    }
                }
            });
```

2. ìƒˆë¡œìš´ captionì—ì„œ hashtagë¥¼ ì¶”ì¶œí•œ í›„ connect

- ìƒˆë¡œìš´ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë¡œ ë§Œë“¤ê¸°(uploadPhoto ì½”ë“œ ì¬í™œìš©)

```js
// photos.utils.js
export const processHashtags = (caption) => {
    // caption.match(/#[\w]+/g) ê°€ nullì´ë©´ hashtags = [] (empty array)
    const hashtags = caption.match(/#[\w]+/g) || [];
    return hashtags.map(hashtag => ({
        where: { hashtag },
        create: { hashtag }
    }));
}
```

```js
// editPhoto.resolvers
const photo = await client.photo.update({
                where: {
                    id
                },
                data: {
                    caption,
                    hashtags: {
                        disconnect: oldPhoto.hashtags,
                        connectOrCreate : processHashtags(caption), // ì¶”ê°€
                    }
                }
            });
```



### #6.9 Like Unlike Photos

- Like model ì‘ì„±

  - like ë¥¼ modelë¡œ ë§Œë“œëŠ” ì´ìœ ëŠ”.. likeì™€ photo, userê°„ì˜ ê´€ê³„ê°€ ì‹¤ì œë¡œ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì´ë‹¤(ex. userê°€ ì¢‹ì•„ìš”í•œ ì‚¬ì§„ë“¤, userê°€ ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¿ëŠ”ì§€ ì•ˆëˆŒë €ëŠ”ì§€ ì—¬ë¶€ ë“±)

  - photoId, userIdëŠ” ì‹¤ì œ dbì— ì €ì¥ë˜ì§€ë§Œ photo, userëŠ” for prisma only

```js
// schema.prisma
model Like {
  id        Int      @id @default(autoincrement())
  photo     Photo    @relation(fields: [photoId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  photoId   Int
  userId    Int
  
  @@unique([photoId,userId]) // ë‘ê°€ì§€ í•„ë“œë¥¼ ë™ì‹œì— uniqueë¡œ ì„¤ì •
    // í•œ ì‚¬ì§„ ë‹¹ like í•œê°œ
    // ìœ ì €ëŠ” í•œ ì‚¬ì§„ì— like í•œë²ˆ
}
```

- and this is for graphql

```js
// photos.typeDefs
type Like {
        id : String!
        photo: Photo!
        createdAt : String!
        updatedAt : String!
    }
```



- likePhoto -> toggleLike (if the photo is not "liked", then like it / if the photo is already liked, then unlike it)





### #6.10 Like Unlike photos part 2

- check out the codes `toggleLike.resolvers.js`

```js
const likeWhere = {
                photoId_userId: {  // @@uniqueë•ë¶„ì— ì´ë˜ë‚˜ì˜´
                    userId: loggedInUser.id,
                    photoId: id,
                }
            }
```

#### counting likes(of certain photo)

- computed field

```js
// photos.resolvers
Photo: {
    likes: ({ id }) => client.like.count({
            where: {
                photoId: id,
            }
        })
}
```



### #6.11 seeLikes

```js
// seePhotoLikes.resolvers.js

const likes = await client.like.findMany({
                where: {
                    photoId: id,
                },
                select: {
                    user: true,
                },
            });
			// user arrayë¥¼ return 
            return likes.map(like => like.user);
// like ì—ì„œ user í•„ë“œë§Œ selectí•´ì„œ ê°€ì ¸ì˜´ (ë‹¤ë¥¸ ê°ì²´ëŠ” ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ)
// includeë¡œ ì“°ë©´ ë‹¤ë¥¸ ê°ì²´ê¹Œì§€ ë‹¤ ê°€ì ¸ì˜¤ë©´ì„œ + userê¹Œì§€ ê°€ì ¸ì˜´
```

â­â­ **selectì™€ include ì°¨ì´** â­â­

- includeëŠ” ê²°ê³¼ì— relationshipì„ ì¶”ê°€í•´ì£¼ê³ 
- selectëŠ” ë§ê·¸ëŒ€ë¡œ ë°›ê³  ì‹¶ì€ ë°ì´í„°ë¥¼ ì„ íƒ

- ë‘˜ì„ ê°™ì´ ì“¸ ìˆ˜ëŠ” ì—†ìŒ
- userì˜ ì–´ë–¤ ë¶€ë¶„ì„ ë°›ê³  ì‹¶ì€ì§€ ëª…ì‹œí•´ ì¤„ ìˆ˜ ìˆìŒ

```js
// ì„ íƒëœ ë°ì´í„°ì—ì„œ ë˜ ì„ íƒ
select : {
    user : {
        select : {
            username : true,
        }
    }
}
```



### #6.12 seeFeed

- "follower ëª©ë¡ì— ë‚´ê°€ ìˆëŠ” ìœ ì €"ì˜ photo + ë‚´ê°€ ê°€ì§„ photo í‘œì‹œ

```js
// seeFeed.resolvers
seeFeed: protectedResolver((_, __, { loggedInUser }) => client.photo.findMany({
            where: {
                OR: [
                    { // follower ëª©ë¡ì— ë‚´ê°€ ìˆëŠ” ìœ ì €
                        user: {
                            followers: {
                                some: {
                                    id: loggedInUser.id,
                                }
                            }
                        }
                    },
                    { // ë‚˜
                        userId: loggedInUser.id,
                    }
                ]
            },
            orderBy: { // ìµœì‹  ìˆœ ì •ë ¬
                createdAt: "desc",
            }
        }))
```



### #6.13 Comment on photos

- createComment.resolvers / typeDefs.js í™•ì¸

