# 0711

### #6.6 seeHashtag

```js
// playground 
{
  seeHashtag(hashtag:"#food"){
    photos { // relation field(?)
      file
      id
    }
    totalPhotos // computed field
  }
}
```

❓ photos 필드도 computed field 라고 함? 모르겟다

- photos, totalPhotos의 resolver가 필요한데 photos.resolver 안에 써줄 수 있음

1. **totalPhotos**

```js
// photos.resolvers에 추가
 Hashtag: {
        totalPhotos: ({ id }) => client.photo.count({
            where: {
                hashtags: {
                    some: {
                        id,
                    }
                }
            }
        })
    }
// photo 중 그 hashtags에 parent의 id와 같은 id의 hashtag가 있는 photo를 모두 count
```

⭐⭐ query 외에, Hashtag 같은 type 안에서 resolver fieldㄹ르 작성할때는 parent(root)를 꼭꼭 써줘야함~



2. **photos**

⭐ new! ⭐ **필드 속에 argument 넣을수있다**

```js
// pg
{
  seeHashtag(hashtag:"#food"){
    photos (page:1) { // 이렇게
      file
      id
    }
  }
}

// photos.typeDefs
type Hashtag {
    photos(page:Int!): [Photo] // 수정
}
```

- seeHashtag.resolvers/typeDefs 에 argument를 추가하지 않아도 됨



### #6.7 editPhoto part 1

- user 타입에도 photos:[Photo] 추가 / users.resolvers에도 추가
- searchPhoto : check out the code
- editPhoto
  - findUnique()는 조건이 고유속성인 경우만 사용할 수 있음 => userId로 찾기위해 findFirst() 사용

```js
// editPhoto.resolvers
editPhoto: protectedResolver(async (_, { id, caption }, { loggedInUser }) => {
            const ok = await client.photo.findFirst({
                where: {
                    id,
                    userId: loggedInUser.id,
                },
            });
            if (!ok) {
                return {
                    ok: false,
                    error: "Photo not found"
                }
            }
    
            const photo = await client.photo.update({
                where: {
                    id
                },
                data : {
                    caption,
                }
            });
        }),
```

+ mutation의 경우 return Result type을 만드는게 좋은 것 같다는 니꼬의 생각



### #6.8 editPhoto part 2

- caption을 업데이트해도 hashtag들은 이전 것 그대로라는 문제가 있음

1. oldPhoto에서 기존의 해시태그들을 받아 모두 disconnect

```js
const oldPhoto = await client.photo.findFirst({
                where: {
                    id,
                    userId: loggedInUser.id,
                },
                inclue : {
                    hashtags : { 
                        // hashtags:true 하면 모든 정보를 다받아오니까 이렇게함
                        select : {
                            hashtag : true,
                        }
                    }
                }
            });
...
const photo = await client.photo.update({
                where: {
                    id
                },
                data: {
                    caption,
                    hashtags: { // disconnect
                        disconnect: oldPhoto.hashtags,
                    }
                }
            });
```

2. 새로운 caption에서 hashtag를 추출한 후 connect

- 새로운 유틸리티 함수로 만들기(uploadPhoto 코드 재활용)

```js
// photos.utils.js
export const processHashtags = (caption) => {
    // caption.match(/#[\w]+/g) 가 null이면 hashtags = [] (empty array)
    const hashtags = caption.match(/#[\w]+/g) || [];
    return hashtags.map(hashtag => ({
        where: { hashtag },
        create: { hashtag }
    }));
}
```

```js
// editPhoto.resolvers
const photo = await client.photo.update({
                where: {
                    id
                },
                data: {
                    caption,
                    hashtags: {
                        disconnect: oldPhoto.hashtags,
                        connectOrCreate : processHashtags(caption), // 추가
                    }
                }
            });
```



### #6.9 Like Unlike Photos

