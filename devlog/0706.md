# ğŸ¦Š DEVLOG 7/6

### #4.15 File Upload part 2

- file upload í•˜ê¸°ìœ„í•´ (playgroundì—ì„  í•  ìˆ˜ ì—†ìŒ)  **altair**  ë‹¤ìš´ë¡œë“œ í•„ìš”  (í¬ë¡¬ í™•ì¥í”„ë¡œê·¸ë¨ - altair graphql client)
- ì¢Œì¸¡ë©”ë‰´ì— setHeaders ë¡œ í† í° ì„¸íŒ…í•˜ê¸°



```js
// editProfile.typeDefs.js

type Mutation {
    editProfile(
        firstName:String
        lastName : String
        username : String
        email : String
        password : String
        bio : String
        avatar : Upload  // ì¶”ê°€
    ) : EditProfileResult
}
`
```

```
// altair (altair ë¬¸ë²•(?))
mutation ($bio:String, $avatar:Upload) {
  editProfile(bio:$bio, avatar:$avatar){
    ok
    error
  }
}

// í•˜ë‹¨ variables
{
	"bio" : "i'm super happy"
}
// í•˜ë‹¨ add files ì— avatarì´ë¦„ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ
```

- editProfileì˜ í•¨ìˆ˜ì—ì„œ console.log(avatar) ë¥¼ ì°ì–´ë³´ë©´ (requestë¥¼ ë³´ë‚¼ ë•Œ) fileì´ ë“¤ì–´ìˆëŠ” promiseê°€ ì¶œë ¥ëœë‹¤



-  ë³´í†µ ì„¸ê°€ì§€ ê³¼ì •
  1. ìœ ì €ê°€ ë‚´ ì„œë²„ì— íŒŒì¼ì„ ì—…ë¡œë“œ
  2. ë‚´ê°€ awsì— ê·¸ íŒŒì¼ì„ ì—…ë¡œë“œ
  3. awsê°€ ë‚˜ì—ê²Œ urlì„ ì¤€ë‹¤



### #4.16 File Upload part 3

- createReadStream : reading the file

```js
// editProfile.resolvers.js

    const {filename, createReadStream} = await avatar;
    const stream = createReadStream();
    console.log(stream);
```

- ì—ëŸ¬í•´ê²°



### #4.17 File Upload part 4

- íŒŒì¼ì„ ì½ëŠ”ë°ëŠ” ì„±ê³µ, íŒŒì¼ì„ ì—…ë¡œë“œ
- **"readStream ì„ pipeë¥¼ í†µí•´ writeStreamìœ¼ë¡œ íë¥´ê²Œ í•œë‹¤"**

1. instaclone/uploads í´ë” ìƒì„±
2. piping
   - process.cwd() : í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ë³´ì—¬ì¤Œ

```js
// editProfile.resolvers.js
import fs from "fs";
...
    const {filename, createReadStream} = await avatar;
    const readStream = createReadStream();
    const writeStream = fs.createWriteStream(process.cwd() + "/uploads/" + filename); // awsë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ°ì½”ë“œëŠ” ì•ˆì¨ë„ ëœëŒ€
    readStream.pipe(writeStream);

```

3. altairì—ì„œ mutation ì‹¤í–‰í•´ë³´ë©´ uploadsì— ì—…ë¡œë“œí•œ íŒŒì¼ì´ ë“¤ì–´ì™€ìˆìŒ



- localhost:4000/uploads/(filename) ì— ê°€ë„ ì´ë¯¸ì§€ë¥¼ ë³¼ ìˆ˜ ì—†ìŒ << apollo serverëŠ” uploads í´ë”ë¥¼ ì½ê³  ìœ ì €ì—ê²Œ ë³´ì—¬ì£¼ëŠ” ê¸°ëŠ¥ì´ ì—†ê¸° ë•Œë¬¸
- ì•ìœ¼ë¡œ ì„œë²„ë¥¼ expressë¡œ ë§Œë“¤ê³  grpahql urlì— ëŒ€í•´ì„œë§Œ apollo serverë¥¼ ì‚¬ìš© (ì•ìœ¼ë¡œëŠ” ìš°ë¦¬ê°€ ëª¨ë“  ê±¸ ë§Œë“¤ê³  apollo serverë¥¼ ì–¹ì„ê±°ì„) => uploads í´ë” ê°™ì€ ê±¸ ì„¤ì •í•  ìˆ˜ ìˆìŒ 

### #4.18 Ejecting from apollo server

- apollo serverë¥¼ apollo server expressë¡œ ì „í™˜ (apollo serverëŠ” í•  ìˆ˜ ìˆëŠ”ê²Œ ì œí•œì )
- express serverë¥¼ ë§Œë“¤ê³  apollo serverì— ì¶”ê°€
- npm i express apollo-server-express

```js
// server.js

import express from "express";  // ì¶”ê°€
import { ApolloServer } from "apollo-server-express";  // ìˆ˜ì •

const app = express();
server.applyMiddleware({app}); // apollo serverê°€ express serverì™€ í•¨ê»˜ ì‘ë™

app
    .listen({port:PORT}, ()=>{ // ìˆ˜ì •
        console.log(`ğŸ‰ Server is running on http://localhost:${PORT}/graphql`);
    });
```

- morgan : ëª¨ë“  ìš”ì²­ì„ ë³´ì—¬ì¤Œ

  npm i morgan

```js
// server.js

import logger from "morgan";
...
app.use(logger("tiny"));
```

- applyMiddleware ëŠ” logger ë‹¤ìŒì— ì¨ì¤˜ì•¼í•¨!
- ê¸°ì¡´ ì½”ë“œì™€ ì°¨ì´ì ì€ ì„œë²„ê°€ exposedë˜ì—ˆë‹¤ëŠ” ê²ƒì´ë‹¤



### #4.19 Changing avatar

- ì´ì „ì— ë§í–ˆë“¯ì´ uploads í´ë”ê°€ ì¸í„°ë„·ì— exposed ë˜ì–´ìˆì§€ ì•ŠìŒ 
- uploads í´ë”ë¥¼ static urlë¡œ ì˜¬ë¦°ë‹¤

```js
// server.js

app.use("/static", express.static("uploads")); // express ê¸°ë³¸ê°œë… í™•ì¸
```

=> localhost:4000/static/(filename) ì—ì„œ ì´ë¯¸ì§€ ë³¼ ìˆ˜ ìˆìŒ



- ì´ì œ editProfileì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì´ë¯¸ì§€ì˜ ê²½ë¡œë¥¼ ì¶”ê°€í•˜ë„ë¡ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤

  (ì‚¬ì‹¤ ì•„ë˜ ì½”ë“œëŠ” ë¬´ì˜ë¯¸ << ì‚¬ì§„ì„ AWSì— ë°”ë¡œ ì—…ë¡œë“œí• ê±°ê¸° ë•Œë¬¸)

```js
// editProfile.resolvers.js

let avatarUrl = null;
    if (avatar){
        const {filename, createReadStream} = await avatar;
        const newFilename = `${loggedInUser.id}-${Date.now()}-${filename}`;
        const readStream = createReadStream();
        const writeStream = fs.createWriteStream(process.cwd() + "/uploads/" + newFilename);
    	readStream.pipe(writeStream);
    	avatarUrl = `http://localhost:4000/static/${newFilename}`;        
    }


...
const updatedUser = await client.user.update({
    where:{
        id:loggedInUser.id,
    }, 
    data:{
        firstName, 
        lastName, 
        username, 
        email, 
        bio,
        ...(uglyPassword && {password:uglyPassword}),
        ...(avatarUrl && {avatar : avatarUrl}),  // avatarUrlì´ ì¡´ì¬í•œë‹¤ë©´
    }});
```

- ë‹¤ì‹œ altairì—ì„œ editProfile ì‹¤í–‰í•˜ë©´ prisma studioì—ì„œ avatar columnì— urlì´ ì¶”ê°€ëœ ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤

```js
// altair

mutation ($bio:String, $avatar:Upload) {
  editProfile(bio:$bio, avatar:$avatar){
    ok
    error
  }
}

// variables
{
  "bio":"im super excited"
}
```



### #4.20 Followers part 1

- ì¼ë‹¨ ìœ ì € í•˜ë‚˜ ë” ë§Œë“¤ê¸°

- íŒ”ë¡œì‰, íŒ”ë¡œìš°ëŠ” **self-referencing relationship** : userë¼ë¦¬ ì„œë¡œì„œë¡œ íŒ”ë¡œì‰, íŒ”ë¡œìš°

  â­ğŸ¥•â­ A.followers[] ë¼ëŠ” User arrayê°€ ìˆê³ (Aë¥¼ follow í•˜ëŠ” user array) / B.following[] ì´ë¼ëŠ” User arrayê°€ ìˆìœ¼ë©´ (Bê°€ follow í•˜ëŠ” user array) / B.following ì— Aê°€ ì¶”ê°€ë˜ëŠ” ìˆœê°„ A.followers ì—ë„ Bê°€ ì¶”ê°€ë˜ê²Œ ëœë‹¤ (ë‘ arrayëŠ” ì„œë¡œë¥¼ ì°¸ì¡°í•´ì•¼í•¨)

```js
// schema.prisma

model User { // ì—ë‹¤ê°€ ì¶”ê°€
    // @relation("ì´ relationì˜ ì´ë¦„", references(ë°˜ëŒ€í¸ì—ë„ ì¡´ì¬í•´ì•¼í•¨))
    // ë‘ relationì˜ ì´ë¦„ì´ ê°™ì•„ì•¼í•¨
  followers User[] @relation("FollowRelation", references:[id])
  following User[] @relation("FollowRelation", references:[id])
}
```

- migrateí•˜ê³  npm run studio ì¬ì‹¤í–‰

- prisma studioì—ì„œ follow ë¥¼ ìˆ˜ì •í•˜ë©´ ë°˜ëŒ€í¸ followì—ë„ ë°˜ì˜ë¨!(?)

  ex) user 2ê°€ user1 ì„ following í•˜ë„ë¡ ìˆ˜ì •í•˜ë©´ user1ì˜ followers ì— ìë™ìœ¼ë¡œ user2ê°€ ë“¤ì–´ê°!!! ì™•ì‹ ê¸°!ğŸ‰ğŸ‰ğŸ‰



### #4.21 Following User

- #4.20ì—ì„œëŠ” followë¥¼ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„, ì´ì œ graphqlë¡œ êµ¬í˜„í•  ì°¨ë¡€

```js
// followUser.typeDefs.js

import { gql } from "apollo-server";


export default gql`

type FollowUserResult {
    ok: Boolean!
    error : String
}

type Mutation {
   followUser(username:String): FollowUserResult 
	// loginëœ userê°€ followí•˜ê³  ì‹¶ì€ userì˜ usernameì´ ì „ë‹¬ë¨
}
`
```

- connect ëŠ” prisma studioì—ì„œ ìˆ˜ë™ì ìœ¼ë¡œ follow, unfollowë¥¼ ì²´í¬í•˜ëŠ” ê²ƒê³¼ ê°™ì€ í–‰ìœ„ (id, email, username ë“± uniqueí•œ fieldì— ì˜í•´ì„œë§Œ connect ë  ìˆ˜ ìˆë‹¤)

  â“ many-to-many fieldë‘ ë¹„ìŠ·í•œê±´ê°€?

```js
// followUser.resolvers.js

import client from "../../client"
import { protectedResolver } from "../users.utils"

export default{
    Mutation : {
        // (root, arg, context, info)
        followUser : protectedResolver(async (_,{username},{loggedInUser}) => {
            
            // ì „ë‹¬ëœ usernameì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” userì¼ ê²½ìš° error
            const ok = await client.user.findUnique({where:{username}});
            if (!ok){
                return {
                    ok:false,
                    error:"That user does not exist."
                }
            }
            
            await client.user.update({
                where: {
                    id:loggedInUser.id,
                },
                data : {
                    following : {
                        connect : {
                            username,
                        }
                    }
                }
            })
            return {
                ok : true,
            }
        })
    }
}
```



### #4.22 Unfollow User and See Followers

#### unfollow

- unfollow : follow ì™€ ê³¼ì • ê±°ì˜ ë™ì¼ , connect ë§Œ disconnectë¡œ ë°”ê¿”ì£¼ë©´ ë¨
- follower ë¥¼ ì ˆëŒ€ ì§ì ‘ ë°”ê¾¸ì§€ x << ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨?



#### see followers

1. users.typeDefs ì— following, followers ì¶”ê°€ (íƒ€ì… : [User])
2. playground

```js
seeProfile (username:"menuin"){
    id
    username
    following { // User typeì´ë¯€ë¡œ subfieldë¥¼ ì“¸ ìˆ˜ìˆìŒ
        id
        username
    }
}
```

=> ì´ëŸ¬ë©´ follow ë¦¬ìŠ¤íŠ¸ê°€ ë– ì•¼í•˜ëŠ”ë° nullì´ ë‚˜ì˜´!!

=> following, followersëŠ” relationshipì´ê¸° ë•Œë¬¸ (**relationshipì€ ë°ì´í„°ë² ì´ìŠ¤ ì¸¡ë©´ì—ì„œ ê°’ë¹„ì‹¸ë‹¤** - ex) í˜¸ë‚ ë‘ì˜ íŒ”ë¡œì›ŒëŠ” 2ì–µì´ ë„˜ëŠ”ë° ê·¸ëŸ¼ followers ë¦¬ìŠ¤íŠ¸ì— 2ì–µê°œë¥¼ ë‹¤ ë³´ì—¬ì¤„ê±°ì„?? - x

- follower ìˆ˜ê°€ ì ë‹¹í•œ ìˆ˜ì¤€ì´ë¼ë©´ ì´ë ‡ê²Œ ì“¸ ìˆ˜ ìˆë‹¤
  - include ê¸°ëŠ¥ì€ prismaê°€ ì‚¬ìš©ìë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ê¸°ë³¸ì ìœ¼ë¡œ êº¼ì ¸ìˆë‹¤

```js
// seeProfile.resolvers.js

seeProfile : (_, {username}) => client.user.findUnique({
            where  : {
                username,
            },
            include : {  // ê´€ê³„ë¥¼ includeí•˜ë€ ì†Œë¦¬
                following : true,
                followers : true,
            }
        }),
```

- REMEMBER : followingì€ prisma clientë¥¼ ë‹¤ì‹œ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— (schemaìˆ˜ì •, regenerate client) includeí•  ìˆ˜ìˆëŠ”ê²ƒ(?)
