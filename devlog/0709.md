# ðŸ¥• DEVLOG 7/9

### #6.0 Photos Model

- dbì—ëŠ” photosì™€ userìžì²´ê°€ ì €ìž¥ë˜ëŠ” ê²Œx >> userIdê°€ ì €ìž¥ë¨
- caption ì´ ìž‘ì„±ë˜ë©´ ê·¸ ì•ˆì—ì„œ hashtagë¥¼ ì¶”ì¶œí•˜ëŠ” ê³¼ì • í•„ìš”(ex. caption : i love #food)

```js
// schema.prismaì— ì¶”ê°€
model User {
    photos Photo[] // ì¶”ê°€
}

model Photo {
  id        Int       @id @default(autoincrement())
  user      User      @relation(fields: [userId], references: [id])
  // field 'userId' is holding the 'id' of user(of photo)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    Int
  file      String
  caption   String?
  hashtags  Hashtag[] // ì‹¤ì œ dbì— ì €ìž¥ë˜ì§€ ì•ŠìŒ
}

model Hashtag { // many-to-many
  id        Int      @id @default(autoincrement())
  hashtag   String   @unique // ì¤‘ë³µ ë¶ˆê°€ëŠ¥
  photos    Photo[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### #6.1 Prisma fields vs SQL fields

- userëŠ” ì‹¤ì œ dbì— ì €ìž¥ë˜ì§€ ì•ŠëŠ”ë‹¤ (hashtagë„)  -> íŠ¹ì •í•­ëª©ì€ prismaê°€ ì•ˆë³´ì´ëŠ” ê³³ì—ì„œ ìžë™ì ìœ¼ë¡œ ê´€ë¦¬(ëª¨ë“  relationsë¥¼?)



### #6.2 Upload Photo part 1

- hashtag ëª¨ë“ˆì€ 

  1. Photo ëª¨ë“ˆê³¼ í•œ ê°œì˜ ëª¨ë“ˆë¡œ ë¬¶ê±°ë‚˜ (ëª¨ë¸ê°„ ì˜ì¡´ì„±ì´ ê°•í•  ê²½ìš° ex) hashtagëŠ” photosì—†ì´ ì¡´ìž¬í•  ìˆ˜ ì—†ìŒ)
  2. ë…ë¦½ì ì¸ ëª¨ë“ˆë¡œ ë¶„ë¦¬ (ëª¨ë¸ ê°„ ì˜ì¡´ì„±ì´ ì•½í•  ê²½ìš° ex) hashtagëŠ” photoë¿ë§Œ ì•„ë‹ˆë¼ commentì™€ë„ ìƒí˜¸ìž‘ìš©) í•  ìˆ˜ ìžˆìŒ

- likes ë¥¼ photo ëª¨ë“ˆê³¼ ë¬¶ì„ê¹Œ ë¶„ë¦¬í• ê¹Œ / commentë¥¼ ë¬¶ì„ê¹Œ ë¶„ë¦¬í• ê¹Œ ë“±ë“± - í”„ë¡œê·¸ëž˜ë¨¸ì˜ ìžìœ¨ì ì¸ ë””ìžì¸ ì„¤ê³„

  => íŒë‹¨ : likesëŠ” commentì—ë„ ì“°ì¼ ìˆ˜ ìžˆìœ¼ë‹ˆê¹Œ ë¶„ë¦¬í•˜ìž! / commentëŠ” photoê°€ ìžˆì–´ì•¼ë§Œ ì¡´ìž¬í•˜ë‹ˆê¹Œ photoëž‘ ë¬¶ìž! .... ì´ëŸ° ê³ ë¯¼ë“¤ì„ ìŠ¤ìŠ¤ë¡œ í•  ìˆ˜ ìžˆì–´ì•¼ í•œë‹¤

```js
// photos.typeDefs
// Photo ì™€ Hashtagë¥¼ í•˜ë‚˜ì˜ ëª¨ë“ˆë¡œ ë¬¶ì—ˆìŒ

   type Photo {
        id: Int!
        user : User!
        file : String!
        caption : String
        hashtag : [Hashtag]
        createdAt : String!
        updatedAt : String!
    }

    type Hashtag {
        id : String!
        hashtag : String!
        photos: [Photo]
        createdAt : String!
        updatedAt : String!
    }
```

- í´ë” êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŒ

```
photos
	ã„´ uploadPhoto
		ã„´ uploadPhoto.resolvers.js
		ã„´ uploadPhoto.typeDefs.js
	ã„´ photos.typeDefs.js
users
	ã„´ ...
```

### #6.3 Upload Photo part 2

**STEP 1** : parsing caption (to extract hashtag) : **regex** ì‚¬ìš©

ex ) `/#[\w]+/g` : #ìœ¼ë¡œ ì‹œìž‘,  all the "word" down to "blank space"

- js ì—ì„  **match** ì‚¬ìš©

```js
Mutation : {
        uploadPhoto : protectedResolver(async(_,{file,caption},{loggedInUser}) => {
            if (caption){
                // parse caption
                const hastags = caption.match(/#[\w]+/g); // returns array of #
                
                // get or create Hashtags
            }
            // save the photo wwith the parsed hashtags
            // add the photo to the hashtags
        })   
    }
```



**STEP 2** : If hashtag doesn't exist, create one / if exists, get it

- **connectOrCreate** ê¸°ëŠ¥ : ì—°ê²°ì‹œí‚¤ê±°ë‚˜, ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©´ ì¶”ê°€

```js
user : {
    // email="some@email" ì¸ userë¥¼ ì°¾ë˜ê°€ / ì—†ë‹¤ë©´ ê·¸ ì´ë©”ì¼ì„ ê°€ì§„ ìƒˆ userë¥¼ create
    connectOrCreate : {
        where: {email: 'some@email'},
        create: {email: 'some@email'}
    }
}
```



### #6.4 Upload photo part 3

1. caption ì—ì„œ hashtag ì¶”ì¶œ (arrayë¡œ ë°˜í™˜)

2. hashtag array ì— map 

   ```
   hashtags = ["#banana", "#orange"]
   // this to
   hashtagObj = [
   	{
   		where: {
   			hashtag: "#banana"
   		},
   		create : {
   			hashtag: "#banana"
   		}
   	},
   	{
   		where: {
   			hashtag: "#orange"
   		},
   		create : {
   			hashtag: "#orange"
   		}
   	}
   ]
   ```

3. create Photo

```js
// uploadPhoto.resolvers

uploadPhoto: protectedResolver(async (_, { file, caption }, { loggedInUser }) => {
            let hashtagObj = [];
            if (caption) {
                // parse caption
                const hashtags = caption.match(/#[\w]+/g); // array of hashtags
                hashtagObj = hashtags.map(hashtag => ({ where: { hashtag }, create: { hashtag } })) // array of {where:.., create:..}s

                
                return client.photo.create({
                    data: {
                        file,
                        caption,
                        user: {
                            connect: {
                                id: loggedInUser.id,
                            }
                        },
                        // caption ë‚´ì— hashtagê°€ í•˜ë‚˜ë¼ë„ ì¡´ìž¬í•œë‹¤ë©´
                        ...(hashtagObj.length > 0 && {
                            hashtags: {
                                // get or create Hashtags
                                connectOrCreate: hashtagObj,
                            }
                        })
                    }
                })
            }
        })
```



### #6.5 seePhoto

- public resolver (not protected)

```js
// playground
{
    seePhoto(id:1){
        user {
            username
        }
    }
}
// error
// "cannot return null for non-nullable field Photo.user" 
```

=> photosì˜ resolverë¥¼ ìž‘ì„±í•´ì•¼í•¨(computed fields?)

- ëª¨ì§•,, í•„ë“œ íƒ€ìž…ì´ ë‹¤ë¥¸ ëª¨ë¸(User, Hashtag)ì´ë©´ computed fieldë¡œ ë³´ëŠ”ê±´ê°€â“â“
- computed fieldë¥¼ ìž‘ì„±í•  ë•Œ rootë¥¼ ëª…ì‹œí•´ì¤˜ì•¼í•œë‹¤!

```js
// photos.resolvers
import client from "../client"

export default {
    Photo: {
        user: ({ userId }) => {
            return client.user.findUnique({ where: { id: userId } });
        },
    }
}
```

â­â­â­ ì•„ ì´ê±° í•´ê²°(?)í•¨!! (#4.22ì— see followers ì°¸ê³ )

- Photo íƒ€ìž…ì˜ í•„ë“œ userëŠ” relationshipì´ê¸° ë•Œë¬¸ì—(ë°ì´í„°ë² ì´ìŠ¤ ë¹„ìš©â†‘) ê¸°ë³¸ì ìœ¼ë¡œ includeë˜ì–´ìžˆì§€ ì•ŠìŒ
- include ì‚¬ìš©í•˜ë©´ ì´ë ‡ê²Œ ì¨ì£¼ë©´ ë¨

```js
// seePhoto.resolvers
import client from "../../client";

export default {
    Query: {
        seePhoto: (_, { id }) => client.photo.findUnique({
            where: {
                id,
            },
            include: { // ì¶”ê°€
                user: true,
            }
        })
    }
}
```

â­ resolverë¥¼ ë”°ë¡œ ë§Œë“œëŠ” ê²ƒê³¼ ì°¨ì´ì  â­ : "í•­ìƒ" hashtagì™€ userì˜ ë°ì´í„°ê°€ í•„ìš”í•˜ë‹¤ë©´ includeì‚¬ìš©ì´ ì¢‹ì„ ìˆ˜ ìžˆìœ¼ë‚˜ hashtagsë‚˜ userë¥¼ í˜¸ì¶œí•˜ë“  í˜¸ì¶œí•˜ì§€ ì•Šë“  ë°ì´í„°ë¥¼ ì¼ë‹¨ ê°€ì ¸ì˜¨ë‹¤ëŠ” ë‹¨ì ì´ ìžˆìŒ / resolverë¡œ ë§Œë“¤ì–´ë‘”ë‹¤ë©´ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ userì™€ hashtagë¥¼ ë‹¬ë¼ê³  ìš”ì²­í•  ë•Œë§Œ resolverë¥¼ ì°¾ì•„ì„œ userì™€ hashtags ë°˜í™˜

í•œë‹¤ê³  í•¨.



- hashtag ê²½ìš° userëž‘ ë‹¤ë¥´ê²Œ requiredê°€ ì•„ë‹ˆë¼ì„œ nullì´ ì¶œë ¥ë¨

```js
// playground
{
    seePhotos(id:1){
        hashtags {
            hashtag
        }
    }
}
```

```js
// photos.resolvers
import client from "../client"

export default {
        hashtags: ({ id }) => client.hashtag.findMany({
            where: {
                photos: {
                    some: {
                        id,
                    }
                }
            }
        })
    }
}
```

