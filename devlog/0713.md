# ğŸ‘ DEVLOG 7/13

### #7 Direct Messages

### #7.0 Introduction

- **ì‹¤ì‹œê°„** ê¸°ìˆ  w/ GraphQL

- ì¸ìŠ¤íƒ€ê·¸ë¨ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë‘ ì•½ê°„ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
- ì‹¤ì œ ì¸ìŠ¤íƒ€ê·¸ë¨ì²˜ëŸ¼ ì‚¬ìš©ìê°€ ë§ì€ ê²½ìš° ë” ì„±ëŠ¥ì´ ì¢‹ì€ ì–¸ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ (ex. erlang, elixir..)



### #7.1 Models

- ëŒ€í™”ë°© ë§Œë“¤ê¸° (model Room) - ë©”ì„¸ì§€ ë§Œë“¤ê¸° (model Message) - ëŒ€í™”ë°©ìœ¼ë¡œ ë³´ë‚´ê¸°

```js
// prisma.schema
model Room {
  id        Int       @id @default(autoincrement())
  users     User[]  // í•œ ê°œì˜ roomì€ ì—¬ëŸ¬ëª…ì˜ userë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ
  Message   Message[]
  ...
}

model User {
    rooms Room[] // ìˆ˜ì • - í•œ ëª…ì˜ userëŠ” ì—¬ëŸ¬ê°œì˜ roomì— ì†í•  ìˆ˜ ìˆìŒ
}
    
model Message {
  id        Int      @id @default(autoincrement())
  payload   String  // ë©”ì„¸ì§€ ë‚´ìš©
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  room      Room     @relation(fields: [roomId], references: [id])
  roomId    Int
}

```



### #7.2 seeRooms

- ì½”ë“œ ì°¸ê³ 

### #7.3 sendMessage(createRoom)

- createRoom happens when someone sends a message to other person (not with pushing any button of "creating a room")
  - roomId ì™€ userIdëŠ” not "required" : ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì€ ë‘ê°€ì§„ë°
    1. (ì´ë¯¸ ì¡´ì¬í•˜ëŠ”) roomì— ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ê±°ë‚˜
    2. (roomì´ ë§Œë“¤ì–´ì§€ì§€ ì•Šì€ ìƒíƒœì—ì„œ) userì—ê²Œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ê±°ë‚˜

```js
// sendMessage.typeDefs
type Mutation {
        sendMessage(payload:String!, roomId:Int, userId:Int) : MutationResponse!
    }
```

**resolver ì‘ì„±**

1. userIdê°€ ì¡´ì¬í•  ê²½ìš° (room ì—†ìŒ. userì—ê²Œ ë©”ì„¸ì§€ ë³´ëƒ„)

```js
if (userId){
                // find user
                const user = await client.user.findUnique({
                    where : {
                        id : userId,
                    },
                });
                // throw error if user not found
                if (!user) {
                    return {
                        ok:false,
                        error : "This user does not exist."
                    };
                }
                // create a new room
                const newRoom = await client.room.create({
                    data : {
                        users: {
                            // connect to user array(loggedInUser & user that i send message to) 
                            connect : [ 
                                {
                                    id : userId
                                },
                                {
                                    id : loggedInUser.id
                                }
                            ]
                        }
                    }
                });
                // create a new message
                const newMessage = await client.message.create({
                    data : {
                        payload,
                        room : {
                            connect : {
                                id : newRoom.id,
                            }
                        },
                        user : {
                            connect : {
                                id : loggedInUser.id,
                            }
                        }
                    }
                })
            }
```



2. roomId ê°€ ì¡´ì¬í•  ê²½ìš° (ì´ë¯¸ ì¡´ì¬í•˜ë˜ roomì— ë©”ì„¸ì§€ ë³´ëƒ„)





### #7.4 seeRoom

- ëŒ€í™”ë°© ë‚´ë¶€

```js
// seeRoom.resolvers
seeRoom : protectedResolver((_,{id},{loggedInUser})=> client.room.findFirst({
    // usersëŠ” roomì˜ ê³ ìœ í•œ feature(?)ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— findUnique()ëŠ” ì“¸ ìˆ˜ ì—†ìŒ
            where: {
                id,
                users : {
                    some : {
                        id : loggedInUser.id,
                    }
                }
            }
        }))
```



**computed fields**

- ëŒ€í™”ë°©ëª©ë¡ì— ë“¤ì–´ê°”ì„ ë•Œ ë³´ì—¬ì•¼ í•˜ëŠ”ê²ƒ 
  - users : ì°¸ì—¬ì ì´ë¦„ / í”„ë¡œí•„ ì‚¬ì§„(avatar)
  - ì•ˆì½ì€ ë©”ì„¸ì§€ ê°œìˆ˜ (unreadTotal)

- ëŒ€í™”ë°©ì— ë“¤ì–´ê°”ì„ ë•Œ ë³´ì—¬ì•¼ í•˜ëŠ” ê²ƒ

  - users : ì°¸ì—¬ì ì´ë¦„ / avatar
  - messages : ë‚´ìš©ë¬¼ / ì½í˜”ëŠ”ì§€ì—¬ë¶€ (seen)

  ```js
  // messages.resolvers.js
  
      Room : {
          users : ({id}) => client.room.findUnique({where : {id}}).users(),
              // userê°€ ë§ì„ê²½ìš° dbë¶€í•˜ => client.user.findmany í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ í•´ì•¼í•¨
          messages: ({id}) => client.message.findMany({
              where : {
                  roomId : id,
              },
          }),
      }
  ```

  

### #7.5 readMessage

- ë©”ì„¸ì§€ ëª¨ë¸ì— read(Boolean) ì¶”ê°€ << unreadTotal êµ¬í˜„ìœ„í•¨

```js
model Message {
    read Boolean @default(false) // defaultê°’ = false
}
```

- unreadTotal

```js
// messages.resolvers
unreadTotal: ({ id }) => client.message.count({
            where: {
                read: false,
                roomId: id,
            }
        }),
```

- unreadTotalì€ ëˆ„ê°€ ê·¸ ë°©ì„ ë³´ëŠëƒì— ë”°ë¼ ê·¸ ê°’ì´ ë‹¤ë¦„ (ex. aê°€ bí•œí…Œ ë©”ì„¸ì§€ë¥¼ ë³´ëƒˆìœ¼ë©´ aì˜ unreadTotal = 0, b=1)
  - ì¦‰ ì´ ëŒ€í™”ë°©ì˜ ë©”ì„¸ì§€ë©´ì„œ / read : false ë©´ì„œ / ë‚´ê°€ ë³´ë‚¸ ë©”ì„¸ì§€ê°€ ì•„ë‹Œ ê²ƒë“¤ì„ ì„¸ì•¼í•¨

```js
unreadTotal: ({ id },_,{loggedInUser}) => client.message.count({
            where: {
                read: false,
                roomId: id,
                user : {
                    id : {
                        not : loggedInUser.id
                    }
                }
            }
        }),
```



**readMessage(marking read on message)**

1. ë©”ì„¸ì§€ê°€ ë‚´ê°€ ë³´ë‚¸ ê²ƒì´ ì•„ë‹˜ì„ í™•ì¸
2. í˜„ì¬ loggedInUserê°€ ë“¤ì–´ê°€ìˆëŠ” ëŒ€í™”ë°© ë‚´ì˜ ë©”ì„¸ì§€ì¸ì§€ í™•ì¸
3. ë©”ì„¸ì§€ê°€ argumentì˜ idë¥¼ ê°€ì¡ŒëŠ”ì§€ í™•ì¸

```js
// readMessage.resolvers

readMessage : protectedResolver(async(_,{id},{loggedInUser}) => {
            const message = await client.message.findFirst({
                where : {
                    // 3
                    id,
                    // 1
                    userId : {
                        not : loggedInUser.id,
                    },
                    // 2
                    room : {
                        users : {
                            some : {
                                id : loggedInUser.id,
                            }
                        }
                    }
                }
            })
        })
```

